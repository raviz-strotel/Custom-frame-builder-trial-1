import React, { useState, useEffect, useRef } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { EyeOff, Eye, ShoppingCart, CheckCircle } from 'lucide-react';\nimport UploadZone from '@/components/UploadZone';\nimport PlainCropper from '@/components/PlainCropper';\nimport PixelStudio from '@/components/PixelStudio';\nimport { advancedPixelate } from '@/utils/advancedPixelate';\nimport { applyImageAdjustments } from '@/utils/imageAdjustments';\n\nexport default function PixelArtConverter() {\n  const [sourceImage, setSourceImage] = useState(null);\n  const [pixelData, setPixelData] = useState(null);\n  const [cropperVisible, setCropperVisible] = useState(true);\n  const [cropBox, setCropBox] = useState({ x: 0, y: 0, width: 0, height: 0 });\n  const [processing, setProcessing] = useState(false);\n  const [adjustments, setAdjustments] = useState({\n    brightness: 0,\n    contrast: 0,\n    saturation: 0,\n    hue: 0\n  });\n  const processingTimeoutRef = useRef(null);\n  const croppedImageRef = useRef(null);\n\n  const handleImageUpload = (img) => {\n    setSourceImage(img);\n    setCropperVisible(true);\n    setPixelData(null);\n  };\n\n  const getCroppedImage = () => {\n    if (!sourceImage || cropBox.width === 0) return null;\n    \n    const canvas = document.createElement('canvas');\n    const ctx = canvas.getContext('2d');\n    \n    // Get image element to calculate scale\n    const imgElement = document.querySelector('img[alt=\"Uploaded\"]');\n    if (!imgElement) return null;\n    \n    const displayWidth = imgElement.width;\n    const displayHeight = imgElement.height;\n    const scaleX = sourceImage.width / displayWidth;\n    const scaleY = sourceImage.height / displayHeight;\n    \n    const cropX = cropBox.x * scaleX;\n    const cropY = cropBox.y * scaleY;\n    const cropWidth = cropBox.width * scaleX;\n    const cropHeight = cropBox.height * scaleY;\n    \n    canvas.width = cropWidth;\n    canvas.height = cropHeight;\n    ctx.drawImage(sourceImage, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);\n    \n    const img = new Image();\n    img.src = canvas.toDataURL();\n    return img;\n  };\n\n  const processImage = () => {\n    const croppedImg = getCroppedImage();\n    if (!croppedImg) return;\n    \n    setProcessing(true);\n    \n    if (processingTimeoutRef.current) clearTimeout(processingTimeoutRef.current);\n    \n    processingTimeoutRef.current = setTimeout(() => {\n      croppedImg.onload = () => {\n        try {\n          const adjustedCanvas = applyImageAdjustments(croppedImg, adjustments);\n          const adjustedImg = new Image();\n          adjustedImg.onload = () => {\n            croppedImageRef.current = adjustedImg;\n            const imageData = advancedPixelate(adjustedImg, 32, true);\n            setPixelData(imageData);\n            setProcessing(false);\n          };\n          adjustedImg.src = adjustedCanvas.toDataURL();\n        } catch (error) {\n          console.error('Processing error:', error);\n          setProcessing(false);\n        }\n      };\n    }, 150);\n  };\n\n  // Process when crop box or adjustments change\n  useEffect(() => {\n    if (sourceImage && cropBox.width > 0) {\n      processImage();\n    }\n  }, [cropBox, adjustments]);\n\n  const handleResetAdjustments = () => {\n    setAdjustments({ brightness: 0, contrast: 0, saturation: 0, hue: 0 });\n  };\n\n  const handleStartOver = () => {\n    setSourceImage(null);\n    setPixelData(null);\n    setCropBox({ x: 0, y: 0, width: 0, height: 0 });\n    handleResetAdjustments();\n  };\n\n  const handleConfirm = () => {\n    alert('Custom frame confirmed! Ready for integration.');\n  };\n\n  const handleAddToCart = () => {\n    alert('Added to cart! This will integrate with your e-commerce workflow.');\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background-primary py-8\">\n      <main className=\"max-w-7xl mx-auto px-4 md:px-8\">\n        {!sourceImage ? (\n          <div className=\"space-y-6\">\n            <div className=\"text-center mb-8\">\n              <h1 className=\"font-manrope font-bold text-3xl text-text-primary mb-2\">Pixel Art Studio</h1>\n              <p className=\"text-text-secondary\">Create custom 32\u00d732 pixel art frames</p>\n            </div>\n            <UploadZone onImageUpload={handleImageUpload} />\n          </div>\n        ) : (\n          <div className=\"space-y-6\">\n            <div className=\"flex justify-between items-center\">\n              <h2 className=\"font-manrope font-bold text-2xl text-text-primary\">Create Your Frame</h2>\n              <Button variant=\"outline\" onClick={handleStartOver}>New Image</Button>\n            </div>\n            \n            {/* Top: Original Image with Cropper */}\n            <div className=\"bg-white rounded-xl border border-border p-6 shadow-sm\">\n              <div className=\"flex justify-between items-center mb-4\">\n                <h3 className=\"font-manrope font-semibold text-lg\">Original Image</h3>\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => setCropperVisible(!cropperVisible)}\n                >\n                  {cropperVisible ? (\n                    <><EyeOff className=\"w-4 h-4 mr-2\" />Hide Cropper</>\n                  ) : (\n                    <><Eye className=\"w-4 h-4 mr-2\" />Show Cropper</>\n                  )}\n                </Button>\n              </div>\n              \n              <div className=\"flex justify-center\">\n                <PlainCropper\n                  image={sourceImage}\n                  cropBox={cropBox}\n                  onCropBoxChange={setCropBox}\n                  visible={cropperVisible}\n                />\n              </div>\n              \n              {!cropperVisible && sourceImage && (\n                <div className=\"flex justify-center\">\n                  <img\n                    src={sourceImage.src}\n                    alt=\"Uploaded\"\n                    className=\"max-w-full h-auto rounded-lg\"\n                    style={{ maxHeight: '500px' }}\n                  />\n                </div>\n              )}\n            </div>\n            \n            {processing && (\n              <div className=\"bg-accent/10 border border-accent/30 rounded-lg p-4 text-center\">\n                <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-accent mx-auto mb-2\"></div>\n                <p className=\"text-sm text-text-secondary\">Processing with advanced algorithms...</p>\n              </div>\n            )}\n            \n            {/* Bottom: Pixel Art Editor */}\n            {pixelData && (\n              <>\n                <PixelStudio\n                  pixelData={pixelData}\n                  onPixelDataChange={setPixelData}\n                  adjustments={adjustments}\n                  onAdjustmentsChange={setAdjustments}\n                  onResetAdjustments={handleResetAdjustments}\n                />\n                \n                {/* Action Buttons */}\n                <div className=\"flex flex-col sm:flex-row gap-3 justify-center\">\n                  <Button\n                    onClick={handleConfirm}\n                    size=\"lg\"\n                    className=\"bg-accent hover:bg-accent-hover text-white font-semibold\"\n                  >\n                    <CheckCircle className=\"w-5 h-5 mr-2\" />\n                    Confirm Custom Frame\n                  </Button>\n                  <Button\n                    onClick={handleAddToCart}\n                    size=\"lg\"\n                    variant=\"outline\"\n                    className=\"border-accent text-accent hover:bg-accent hover:text-white font-semibold\"\n                  >\n                    <ShoppingCart className=\"w-5 h-5 mr-2\" />\n                    Add to Cart\n                  </Button>\n                </div>\n                \n                <div className=\"bg-accent/5 border border-accent/20 rounded-lg p-4\">\n                  <p className=\"text-sm text-text-secondary text-center\">\n                    \u2728 Adjust sliders for real-time changes \u2022 Use tools to perfect your art \u2022 Zoom for precise mobile editing\n                  </p>\n                </div>\n              </>\n            )}\n          </div>\n        )}\n      </main>\n    </div>\n  );\n}
